<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Make the world a better place!"/><title>PHP扩展开发简介 | pein0119</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">PHP扩展开发简介</h1><a id="logo" href="/">pein0119</a><p class="description">pein0119's blog</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">PHP扩展开发简介</h1><div class="post-meta">2014-12-28 | <span class="categories">分类于<a href="/categories/php/">php</a></span></div><div class="post-content"><p>使用C来开发PHP扩展可以极大的提高运行率，但扩展的开发比较复杂、开发周期长，所以，个中利弊还是要自己权衡。<br>本文只是开发PHP扩展的一个简单示范，演示一下PHP扩展开发的一般流程，并不深入研究相关的API。</p>
<a id="more"></a>
<h2 id="第一步、获取源代码">第一步、获取源代码</h2><p>开发扩展我们首先需要一份与你所使用的PHP版本对应的PHP源代码，因为PHP的源代码中有我们所需要的扩展开发环境。</p>
<p>在这里，我使用的是PHP-5.5.33的源代码。</p>
<h2 id="第二步、生成扩展框架">第二步、生成扩展框架</h2><p>进入PHP源代码目录下的ext目录，该目录下有一个名为<code>ext_skel</code>的文件，我们需要用这个文件生成扩展框架。</p>
<p><code>ext_skel</code>文件有以下选项<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=module [--proto=file] [--stubs=file] [--xml[=file]]</span><br><span class="line">[--skel=dir] [--full-xml] [--no-help]</span><br><span class="line"></span><br><span class="line">--extname=module   module is the name of your extension</span><br><span class="line">--proto=file       file contains prototypes of <span class="built_in">functions</span> to create</span><br><span class="line">--stubs=file       generate only <span class="keyword">function</span> stubs <span class="keyword">in</span> file</span><br><span class="line">--xml              generate xml documentation to be added to phpdoc-cvs</span><br><span class="line">--skel=dir         path to the skeleton directory</span><br><span class="line">--full-xml         generate xml documentation <span class="keyword">for</span> a self-contained extension</span><br><span class="line">(not yet implemented)</span><br><span class="line">--no-help          don<span class="string">'t try to be nice and create comments in the code</span><br><span class="line">and helper functions to test if the module compiled</span></span><br></pre></td></tr></table></figure></p>
<p>我们要创建一个名为dump的函数，所以终端输入命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./ext_skel --extname=dump</span><br></pre></td></tr></table></figure>
<p>此时，目录下生成了一个名为dump的目录，该目录就是我们的扩展开发环境，其结构如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── config<span class="class">.m4</span></span><br><span class="line">├── config<span class="class">.w32</span></span><br><span class="line">├── CREDITS</span><br><span class="line">├── dump<span class="class">.c</span></span><br><span class="line">├── dump<span class="class">.php</span></span><br><span class="line">├── EXPERIMENTAL</span><br><span class="line">├── php_dump<span class="class">.h</span></span><br><span class="line">└── tests</span><br><span class="line">    └── <span class="number">001</span>.phpt</span><br></pre></td></tr></table></figure></p>
<h2 id="第三步、更改配置文件">第三步、更改配置文件</h2><p>先要修改config.m4文件，将以下三行前面的注释(dnl)去掉：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnl <span class="type">PHP_ARG_ENABLE</span>(<span class="built_in">dump</span>, whether to enable <span class="built_in">dump</span> support,</span><br><span class="line">dnl <span class="type">Make</span> sure that the comment <span class="keyword">is</span> aligned:</span><br><span class="line">dnl [  --enable-<span class="built_in">dump</span>           <span class="type">Enable</span> <span class="built_in">dump</span> support])</span><br></pre></td></tr></table></figure>
<h2 id="第四步、添加函数声明">第四步、添加函数声明</h2><p>在php_dump.h的47行：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(confirm_dump_compiled);	/<span class="keyword">*</span> For testing, remove later. <span class="keyword">*</span>/</span><br></pre></td></tr></table></figure>
<p>添加一行我们自己的函数声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(dump);</span><br></pre></td></tr></table></figure>
<h2 id="第五步、实现相应功能">第五步、实现相应功能</h2><p>在dump.c的41行：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> zend_function_entry dump_functions[] = &#123;</span><br><span class="line">PHP_FE(confirm_dump_compiled,	<span class="literal">NULL</span>)		<span class="comment">/* For testing, remove later. */</span></span><br><span class="line">PHP_FE_END	<span class="comment">/* Must be the last line in dump_functions[] */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>中添加一行，使其变为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> zend_function_entry dump_functions[] = &#123;</span><br><span class="line">PHP_FE(confirm_dump_compiled,	<span class="literal">NULL</span>)		<span class="comment">/* For testing, remove later. */</span></span><br><span class="line">PHP_FE(dump, <span class="literal">NULL</span>)</span><br><span class="line">PHP_FE_END	<span class="comment">/* Must be the last line in dump_functions[] */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在dump.c文件的末尾添加PHP_FUNCTION(dump)函数的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 核心代码 */</span></span><br><span class="line">PHP_FUNCTION(dump)</span><br><span class="line">&#123;</span><br><span class="line">    zval *zv_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"z"</span>, &amp;zv_ptr) == FAILURE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (Z_TYPE_P(zv_ptr)) &#123;</span><br><span class="line">    <span class="keyword">case</span> IS_NULL:</span><br><span class="line">        php_printf(<span class="string">"NULL: null\n"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_BOOL:</span><br><span class="line">        <span class="keyword">if</span> (Z_BVAL_P(zv_ptr)) &#123;</span><br><span class="line">            php_printf(<span class="string">"BOOL: true\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            php_printf(<span class="string">"BOOL: false\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_LONG:</span><br><span class="line">        php_printf(<span class="string">"LONG: %ld\n"</span>, Z_LVAL_P(zv_ptr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_DOUBLE:</span><br><span class="line">        php_printf(<span class="string">"DOUBLE: %g\n"</span>, Z_DVAL_P(zv_ptr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_STRING:</span><br><span class="line">        php_printf(<span class="string">"STRING: value=\""</span>);</span><br><span class="line">        PHPWRITE(Z_STRVAL_P(zv_ptr), Z_STRLEN_P(zv_ptr));</span><br><span class="line">        php_printf(<span class="string">"\", length=%d\n"</span>, Z_STRLEN_P(zv_ptr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_RESOURCE:</span><br><span class="line">        php_printf(<span class="string">"RESOURCE: id=%ld\n"</span>, Z_RESVAL_P(zv_ptr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_ARRAY:</span><br><span class="line">        php_printf(<span class="string">"ARRAY: hashtable=%p\n"</span>, Z_ARRVAL_P(zv_ptr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IS_OBJECT:</span><br><span class="line">        php_printf(<span class="string">"OBJECT: ???\n"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第六步、编译安装扩展">第六步、编译安装扩展</h2><p>在dump目录下运行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /path/to/phpize</span><br><span class="line">$ ./configure --with-php-config=/path/to/php-config</span><br><span class="line">$ sudo make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
<p>phpize命令用来准备PHP扩展的编译环境, php-config指明了当前PHP环境的一些信息。</p>
<h2 id="第七步、修改PHP-ini">第七步、修改PHP.ini</h2><p>在php.ini中添加<br><figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">extension</span>=<span class="string">dump.so</span></span><br></pre></td></tr></table></figure></p>
<p>而后，重启php-fpm服务</p>
<h2 id="第八步、测试">第八步、测试</h2><figure class="highlight php"><figcaption><span>test.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">echo</span> dump(<span class="variable">$arr</span>);</span><br></pre></td></tr></table></figure>
<p>运行后输出：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ARRAY</span>: <span class="string">hashtable=0x7f4dbf723278</span></span><br></pre></td></tr></table></figure>
<p>证明扩展载入成功，这样，我们就开发完了一个简单的扩展。</p>
</div><div class="tags"><a href="/tags/php/">php</a></div><div class="post-nav"><a href="/2015/02/03/浏览器禁用cookie后如何使用session/" class="pre"><i class="icon-previous">浏览器禁用cookie后如何使用session</i></a><a href="/2014/12/07/NGINX基本管理/" class="next">NGINX基本管理<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/bash/">bash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shadowsocks/">shadowsocks</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法与数据结构/">算法与数据结构</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/SQL注入/" style="font-size: 15px;">SQL注入</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/cookie/" style="font-size: 15px;">cookie</a> <a href="/tags/session/" style="font-size: 15px;">session</a> <a href="/tags/算法与数据结构/" style="font-size: 15px;">算法与数据结构</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/twemproxy/" style="font-size: 15px;">twemproxy</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/php-fpm/" style="font-size: 15px;">php-fpm</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/bash/" style="font-size: 15px;">bash</a> <a href="/tags/emoji/" style="font-size: 15px;">emoji</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/21/shadowsocks报错-IP-127-0-0-1-is-in-forbidden-list-reject/">shadowsocks报错'IP 127.0.0.1 is in forbidden list, reject'</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/23/记一次twemproxy错误排查/">记一次redis错误排查</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/27/bash代码片段/">bash代码片段</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/记一次-nginx-499-排查经历/">记一次'nginx 499'排查经历</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/20/PHP删除字符串中的emoji表情/">PHP删除字符串中的emoji表情</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/20/PHP调试小技巧/">PHP调试小技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/27/分销项目总结/">其实我在胡说八道</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/10/js获取url参数的值/">js获取url参数的值</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/25/MySQL服务器启动错误-The-server-quit-without-updating-PID-file/">MySQL服务器启动错误 'The server quit without updating PID file'</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/18/MySQL删除所有数据库/">MySQL删除所有数据库</a></li></ul></div><div class="widget"><div class="widget-title">友情链接</div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">pein0119.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"></div></body></html>