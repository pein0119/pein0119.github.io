<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Make the world a better place!"/><title>Redis-1.0代码阅读（四） --双向链表的实现 | pein0119</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis-1.0代码阅读（四） --双向链表的实现</h1><a id="logo" href="/">pein0119</a><p class="description">pein0119's blog</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Redis-1.0代码阅读（四） --双向链表的实现</h1><div class="post-meta">2014-08-20 | <span class="categories">分类于<a href="/categories/redis/">redis</a></span></div><div class="post-content"><p>参考资料：<a href="http://www.redisbook.com" target="_blank" rel="external">http://www.redisbook.com</a><br>Redis实现了双向链表，它是Redis的基本数据结构List（列表）的底层实现之一，为实现列表的一系列操作(如：LPUSH,RPUSH,LLEN等)提供了底层的接口。<br><a id="more"></a></p>
<h2 id="文件依赖">文件依赖</h2><p>adlist.c adlist.h zmalloc.h </p>
<h2 id="链表实现">链表实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> listNode &#123;</span><br><span class="line">    <span class="keyword">struct</span> listNode *prev;		<span class="comment">/* 指向前一个结点 */</span></span><br><span class="line">    <span class="keyword">struct</span> listNode *next;		<span class="comment">/* 指向后一个结点 */</span></span><br><span class="line">    <span class="keyword">void</span> *value;				<span class="comment">/* 使用空指针存储任意类型的值 */</span></span><br><span class="line">&#125; listNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> listIter &#123;</span><br><span class="line">    listNode *next;				<span class="comment">/* 指向迭代器当前指向的结点 */</span></span><br><span class="line">    <span class="keyword">int</span> direction;				<span class="comment">/* 指示迭代器的方向，顺序还是逆序 */</span></span><br><span class="line">&#125; listIter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="built_in">list</span> &#123;</span><br><span class="line">    listNode *head;				<span class="comment">/* 指向链表的头部 */</span></span><br><span class="line">    listNode *tail;				<span class="comment">/* 指向链表的尾部 */</span></span><br><span class="line">    <span class="keyword">void</span> *(*dup)(<span class="keyword">void</span> *ptr);	<span class="comment">/* 复制函数的函数指针 */</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *ptr);	<span class="comment">/* 释放函数的函数指针 */</span></span><br><span class="line">    <span class="keyword">int</span> (*match)(<span class="keyword">void</span> *ptr, <span class="keyword">void</span> *key); <span class="comment">/* 匹配函数的函数指针 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;					<span class="comment">/* 存储链表中的结点书 */</span></span><br><span class="line">    listIter iter;						<span class="comment">/* 链表的迭代器 */</span></span><br><span class="line">&#125; <span class="built_in">list</span>;</span><br></pre></td></tr></table></figure>
<p>每个结点中有两个指针，这样可以使用迭代器进行正向和逆向访问。<br>有个疑问，listIter中的direction成员只有两个值，0和1，那么采用char类型存储是否更好？毕竟redis是内存数据库，一个list能节省三字节，对于整个数据库来说，节省下来的内存还是很客观的。<br>list结构示意图：<br><img src="https://github.com/pein0119/pein0119.github.io/blob/master/image/14-08-20-1.jpg?raw=true" alt=""> </p>
<h2 id="用宏实现的函数">用宏实现的函数</h2><p>对于一些比较简单的函数，用宏实现可以避免函数调用带来的开销，提高效率。<br>都是一些很简单的宏   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Functions implemented as macros */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listLength(l) ((l)-&gt;len) <span class="comment">/* 返回链表的长度 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listFirst(l) ((l)-&gt;head) <span class="comment">/* 返回链表的头结点 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listLast(l) ((l)-&gt;tail)	 <span class="comment">/* 返回链表的的尾结点 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listPrevNode(n) ((n)-&gt;prev) <span class="comment">/* 返回前一个结点 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listNextNode(n) ((n)-&gt;next) <span class="comment">/* 返回下一个结点 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listNodeValue(n) ((n)-&gt;value) <span class="comment">/* 返回当前结点存储的值 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listSetDupMethod(l,m) ((l)-&gt;dup = (m)) <span class="comment">/* dup函数指针绑定函数 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listSetFreeMethod(l,m) ((l)-&gt;free = (m)) <span class="comment">/* free函数指针绑定函数 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listSetMatchMethod(l,m) ((l)-&gt;match = (m)) <span class="comment">/* match函数指针绑定函数 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listGetDupMethod(l) ((l)-&gt;dup) <span class="comment">/* 得到dup指针指向的函数 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listGetFree(l) ((l)-&gt;free)	   <span class="comment">/* 得到free指针指向的函数 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> listGetMatchMethod(l) ((l)-&gt;match) <span class="comment">/* 得到match函数指向的函数 */</span></span></span><br></pre></td></tr></table></figure>
<h2 id="剩余函数的详细注释">剩余函数的详细注释</h2><h3 id="1-_listCreate">1. listCreate</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listCreate</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="built_in">list</span> *<span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">list</span> = zmalloc(<span class="keyword">sizeof</span>(*<span class="built_in">list</span>))) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">list</span>-&gt;head = <span class="built_in">list</span>-&gt;tail = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">list</span>-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">list</span>-&gt;dup = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">list</span>-&gt;<span class="built_in">free</span> = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">list</span>-&gt;match = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用zmalloc函为链表分配内存，分配成功后，将链表成员初始化为空。 </p>
<h3 id="2-_listRelease">2. listRelease</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Free the whole list.</span><br><span class="line">*</span><br><span class="line">* This function can't fail. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRelease</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line">    listNode *current, *next;</span><br><span class="line"></span><br><span class="line">    current = <span class="built_in">list</span>-&gt;head;</span><br><span class="line">    len = <span class="built_in">list</span>-&gt;len;</span><br><span class="line">    <span class="keyword">while</span>(len--) &#123;</span><br><span class="line">        next = current-&gt;next;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">list</span>-&gt;<span class="built_in">free</span>) <span class="built_in">list</span>-&gt;<span class="built_in">free</span>(current-&gt;value); <span class="comment">/* 如果指定了free函数，对当前结点的value进行free操作*/</span></span><br><span class="line">        zfree(current);								<span class="comment">/* 释放当前结点 */</span></span><br><span class="line">        current = next;</span><br><span class="line">        &#125;</span><br><span class="line">        zfree(<span class="built_in">list</span>);				<span class="comment">/* 释放整个list */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果指定了list中的free函数成员，先要对listNode中的value进行free操作，最后才释放listNode。释放完所有的listNode，才能释放整个list。   </p>
<h3 id="3-_listAddNodeHead">3. listAddNodeHead</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 向list中的链表头部添加值为value的结点 */</span></span><br><span class="line"><span class="comment">/* Add a new node to the list, to head, contaning the specified 'value'</span><br><span class="line">* pointer as value.</span><br><span class="line">*</span><br><span class="line">* On error, NULL is returned and no operation is performed (i.e. the</span><br><span class="line">* list remains unaltered).</span><br><span class="line">* On success the 'list' pointer you pass to the function is returned. */</span></span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listAddNodeHead</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">void</span> *value)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    listNode *node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((node = zmalloc(<span class="keyword">sizeof</span>(*node))) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;value = value;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span>-&gt;len == <span class="number">0</span>) &#123;		<span class="comment">/* 链表是空的 */</span></span><br><span class="line">        <span class="built_in">list</span>-&gt;head = <span class="built_in">list</span>-&gt;tail = node;</span><br><span class="line">        node-&gt;prev = node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;					<span class="comment">/* 链表不为空 */</span></span><br><span class="line">        node-&gt;prev = <span class="literal">NULL</span>;</span><br><span class="line">        node-&gt;next = <span class="built_in">list</span>-&gt;head;</span><br><span class="line">        <span class="built_in">list</span>-&gt;head-&gt;prev = node;</span><br><span class="line">        <span class="built_in">list</span>-&gt;head = node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">list</span>-&gt;len++;				<span class="comment">/* 增加链表长度 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数在链表的头部增加一个结点。 </p>
<h3 id="4-_listAddNodeTail">4. listAddNodeTail</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 在链表的尾部添加值为value的结点 */</span></span><br><span class="line"><span class="comment">/* Add a new node to the list, to tail, contaning the specified 'value'</span><br><span class="line">* pointer as value.</span><br><span class="line">*</span><br><span class="line">* On error, NULL is returned and no operation is performed (i.e. the</span><br><span class="line">* list remains unaltered).</span><br><span class="line">* On success the 'list' pointer you pass to the function is returned. */</span></span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listAddNodeTail</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">void</span> *value)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    listNode *node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((node = zmalloc(<span class="keyword">sizeof</span>(*node))) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;value = value;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span>-&gt;len == <span class="number">0</span>) &#123;		<span class="comment">/* 链表是空的 */</span></span><br><span class="line">        <span class="built_in">list</span>-&gt;head = <span class="built_in">list</span>-&gt;tail = node;</span><br><span class="line">        node-&gt;prev = node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;					<span class="comment">/* 链表不为空 */</span></span><br><span class="line">        node-&gt;prev = <span class="built_in">list</span>-&gt;tail;</span><br><span class="line">        node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;tail-&gt;next = node;</span><br><span class="line">        <span class="built_in">list</span>-&gt;tail = node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">list</span>-&gt;len++;				<span class="comment">/* 链表的长度加一 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数在链表的尾部添加一个结点 </p>
<h3 id="5-_listDelNode">5. listDelNode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 从链表中删除指定的结点 */</span></span><br><span class="line"><span class="comment">/* Remove the specified node from the specified list.</span><br><span class="line">* It's up to the caller to free the private value of the node.</span><br><span class="line">*</span><br><span class="line">* This function can't fail. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listDelNode</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, listNode *node)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;prev)				<span class="comment">/* 删除的不是头结点 */</span></span><br><span class="line">        node-&gt;prev-&gt;next = node-&gt;next;</span><br><span class="line">    <span class="keyword">else</span>						<span class="comment">/* 删除的是头结点 */</span></span><br><span class="line">        <span class="built_in">list</span>-&gt;head = node-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;next)				<span class="comment">/* 删除的不是尾结点 */</span></span><br><span class="line">        node-&gt;next-&gt;prev = node-&gt;prev;</span><br><span class="line">    <span class="keyword">else</span>						<span class="comment">/* 删除的是尾结点 */</span></span><br><span class="line">        <span class="built_in">list</span>-&gt;tail = node-&gt;prev;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span>-&gt;<span class="built_in">free</span>) <span class="built_in">list</span>-&gt;<span class="built_in">free</span>(node-&gt;value); <span class="comment">/* 如果指定了free函数,*/</span></span><br><span class="line">    <span class="comment">/*对当前结点的value进行free操作 */</span></span><br><span class="line">    zfree(node);							 <span class="comment">/* 释放掉整个结点 */</span></span><br><span class="line">    <span class="built_in">list</span>-&gt;len--;							 <span class="comment">/* 链表长度减1 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从链表中删除指定的结点，如果指定了free函数，需要对value进行free操作。 </p>
<h3 id="6-_listGetIterator">6. listGetIterator</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建指定方向的迭代器 */</span></span><br><span class="line"><span class="comment">/* Returns a list iterator 'iter'. After the initialization every</span><br><span class="line">* call to listNext() will return the next element of the list.</span><br><span class="line">*</span><br><span class="line">* This function can't fail. */</span></span><br><span class="line"><span class="function">listIter *<span class="title">listGetIterator</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">int</span> direction)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    listIter *iter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((iter = zmalloc(<span class="keyword">sizeof</span>(*iter))) == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (direction == AL_START_HEAD) <span class="comment">/* 指定的方向是“从头到尾” */</span></span><br><span class="line">        iter-&gt;next = <span class="built_in">list</span>-&gt;head;</span><br><span class="line">    <span class="keyword">else</span>						<span class="comment">/* 指定的方向是“从尾到头” */</span></span><br><span class="line">        iter-&gt;next = <span class="built_in">list</span>-&gt;tail;</span><br><span class="line">        iter-&gt;direction = direction;</span><br><span class="line">    <span class="keyword">return</span> iter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成一个给定方向的迭代器。 </p>
<h3 id="7-_listReleaseIterator">7. listReleaseIterator</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Release the iterator memory */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listReleaseIterator</span><span class="params">(listIter *iter)</span> </span>&#123;</span><br><span class="line">zfree(iter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>释放迭代器。 </p>
<h3 id="8-_listRewind">8. listRewind</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create an iterator in the list private iterator structure */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRewind</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">list</span>-&gt;iter.next = <span class="built_in">list</span>-&gt;head;</span><br><span class="line">    <span class="built_in">list</span>-&gt;iter.direction = AL_START_HEAD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成一个list私有的迭代器，方向是“从头到尾”。  </p>
<h3 id="9-_listRewindTail">9. listRewindTail</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRewindTail</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">list</span>-&gt;iter.next = <span class="built_in">list</span>-&gt;tail;</span><br><span class="line">    <span class="built_in">list</span>-&gt;iter.direction = AL_START_TAIL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成一个list私有的迭代器，方向是“从尾到头”。  </p>
<h3 id="10-_listNext">10. listNext</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return the next element of an iterator.</span><br><span class="line">* It's valid to remove the currently returned element using</span><br><span class="line">* listDelNode(), but not to remove other elements.</span><br><span class="line">*</span><br><span class="line">* The function returns a pointer to the next element of the list,</span><br><span class="line">* or NULL if there are no more elements, so the classical usage patter</span><br><span class="line">* is:</span><br><span class="line">*</span><br><span class="line">* iter = listGetItarotr(list,&lt;direction&gt;);</span><br><span class="line">* while ((node = listNextIterator(iter)) != NULL) &#123;</span><br><span class="line">*     DoSomethingWith(listNodeValue(node));</span><br><span class="line">* &#125;</span><br><span class="line">*</span><br><span class="line">* */</span></span><br><span class="line"><span class="function">listNode *<span class="title">listNext</span><span class="params">(listIter *iter)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    listNode *current = iter-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;direction == AL_START_HEAD) <span class="comment">/* 迭代器的方向是“从头到尾” */</span></span><br><span class="line">        iter-&gt;next = current-&gt;next;</span><br><span class="line">        <span class="keyword">else</span>                    <span class="comment">/* 迭代器的方向是“从尾到头” */</span></span><br><span class="line">            iter-&gt;next = current-&gt;prev;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回当前迭代器指向的元素，并将迭代器指向下一个元素。  </p>
<h3 id="11-_listYield">11. listYield</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* List Yield just call listNext() against the list private iterator */</span></span><br><span class="line"><span class="function">listNode *<span class="title">listYield</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> listNext(&amp;<span class="built_in">list</span>-&gt;iter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回list私有迭代器当前指向的元素。  </p>
<h3 id="12-_listDup">12. listDup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 复制list */</span></span><br><span class="line"><span class="comment">/* Duplicate the whole list. On out of memory NULL is returned.</span><br><span class="line">* On success a copy of the original list is returned.</span><br><span class="line">*</span><br><span class="line">* The 'Dup' method set with listSetDupMethod() function is used</span><br><span class="line">* to copy the node value. Otherwise the same pointer value of</span><br><span class="line">* the original node is used as value of the copied node.</span><br><span class="line">*</span><br><span class="line">* The original list both on success or error is never modified. */</span></span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listDup</span><span class="params">(<span class="built_in">list</span> *orig)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">list</span> *copy;</span><br><span class="line">    listIter *iter;</span><br><span class="line">    listNode *node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((copy = listCreate()) == <span class="literal">NULL</span>) <span class="comment">/* 创建一个list，如果返回为NULL，常见失败 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;             </span><br><span class="line">    copy-&gt;dup = orig-&gt;dup;        <span class="comment">/* 复制原list中的函数成员 */</span></span><br><span class="line">    copy-&gt;<span class="built_in">free</span> = orig-&gt;<span class="built_in">free</span>;</span><br><span class="line">    copy-&gt;match = orig-&gt;match;</span><br><span class="line">    iter = listGetIterator(orig, AL_START_HEAD);</span><br><span class="line">    <span class="keyword">while</span>((node = listNext(iter)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">void</span> *value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy-&gt;dup) &#123;        <span class="comment">/* 原list指定了dup函数 */</span></span><br><span class="line">            value = copy-&gt;dup(node-&gt;value);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">NULL</span>) &#123; <span class="comment">/* dup操作失败，释放已经分配的资源，返回NULL */</span></span><br><span class="line">                listRelease(copy);</span><br><span class="line">                listReleaseIterator(iter);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span>                    <span class="comment">/* 没指定dup函数 */</span></span><br><span class="line">            value = node-&gt;value;</span><br><span class="line">        <span class="keyword">if</span> (listAddNodeTail(copy, value) == <span class="literal">NULL</span>) &#123; <span class="comment">/* 把orig中结点的value*/</span></span><br><span class="line">        <span class="comment">/*指针赋给copy中的value */</span></span><br><span class="line">            listRelease(copy);                        <span class="comment">/* 如果出错，释放已经分配的资源 */</span></span><br><span class="line">            listReleaseIterator(iter);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    listReleaseIterator(iter);    <span class="comment">/* 释放迭代器 */</span></span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>赋值一个list，成功的话，返回新的list,失败返回NULL。  </p>
<p>如果指定了dup函数，就使用dup函数复制，未指定的话，就将orig lsit中结点的value指针给copy list中的结点。  </p>
<h3 id="13-_listSearchKey">13. listSearchKey</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 返回等于指定key的结点 */</span></span><br><span class="line"><span class="comment">/* Search the list for a node matching a given key.</span><br><span class="line">* The match is performed using the 'match' method</span><br><span class="line">* set with listSetMatchMethod(). If no 'match' method</span><br><span class="line">* is set, the 'value' pointer of every node is directly</span><br><span class="line">* compared with the 'key' pointer.</span><br><span class="line">*</span><br><span class="line">* On success the first matching node pointer is returned</span><br><span class="line">* (search starts from head). If no matching node exists</span><br><span class="line">* NULL is returned. */</span></span><br><span class="line"><span class="function">listNode *<span class="title">listSearchKey</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">void</span> *key)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    listIter *iter;</span><br><span class="line">    listNode *node;</span><br><span class="line"></span><br><span class="line">    iter = listGetIterator(<span class="built_in">list</span>, AL_START_HEAD);</span><br><span class="line">    <span class="keyword">while</span>((node = listNext(iter)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">list</span>-&gt;match) &#123;        <span class="comment">/* 指定了match函数 */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">list</span>-&gt;match(node-&gt;value, key)) &#123;</span><br><span class="line">                listReleaseIterator(iter);</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;                <span class="comment">/* 未指定match函数 */</span></span><br><span class="line">            <span class="keyword">if</span> (key == node-&gt;value) &#123;</span><br><span class="line">                listReleaseIterator(iter);</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    listReleaseIterator(iter);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给定key，遍历list的所有结点，如果指定了match函数，就调用match函数进行比较，如果没有指定match函数，就直接比较两个指针的地址。</p>
<h3 id="14-_listIndex">14. listIndex</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 返回指定索引的结点 */</span></span><br><span class="line"><span class="comment">/* Return the element at the specified zero-based index</span><br><span class="line">* where 0 is the head, 1 is the element next to head</span><br><span class="line">* and so on. Negative integers are used in order to count</span><br><span class="line">* from the tail, -1 is the last element, -2 the penultimante</span><br><span class="line">* and so on. If the index is out of range NULL is returned. */</span></span><br><span class="line"><span class="function">listNode *<span class="title">listIndex</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    listNode *n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;            <span class="comment">/* 索引值是相对于尾部的偏移 */</span></span><br><span class="line">        index = (-index)-<span class="number">1</span>;</span><br><span class="line">        n = <span class="built_in">list</span>-&gt;tail;</span><br><span class="line">        <span class="keyword">while</span>(index-- &amp;&amp; n) n = n-&gt;prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                    <span class="comment">/* 索引值是相对于头部的偏移 */</span></span><br><span class="line">        n = <span class="built_in">list</span>-&gt;head;</span><br><span class="line">        <span class="keyword">while</span>(index-- &amp;&amp; n) n = n-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>索引0代表头结点，1代表头结点的下一个结点，2，3，4…依次类推。索引-1代表的是尾结点，-2代表的尾结点的前一个结点，依次类推。  </p>
<p>返回对应索引的结点。  </p>
<p>（双向链表部分结束）</p>
</div><div class="tags"><a href="/tags/redis/">redis</a></div><div class="post-nav"><a href="/2014/08/20/Redis-10代码阅读（五）---简单动态字符串(sds)的实现/" class="pre"><i class="icon-previous">Redis-1.0代码阅读（五） --简单动态字符串(sds)的实现</i></a><a href="/2014/08/19/Redis-10代码阅读（三）---动态内存分配/" class="next">Redis-1.0代码阅读（三） --动态内存分配<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/bash/">bash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法与数据结构/">算法与数据结构</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/SQL注入/" style="font-size: 15px;">SQL注入</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/cookie/" style="font-size: 15px;">cookie</a> <a href="/tags/session/" style="font-size: 15px;">session</a> <a href="/tags/算法与数据结构/" style="font-size: 15px;">算法与数据结构</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/twemproxy/" style="font-size: 15px;">twemproxy</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/php-fpm/" style="font-size: 15px;">php-fpm</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/bash/" style="font-size: 15px;">bash</a> <a href="/tags/emoji/" style="font-size: 15px;">emoji</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/01/23/记一次twemproxy错误排查/">记一次redis错误排查</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/27/bash代码片段/">bash代码片段</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/记一次-nginx-499-排查经历/">记一次'nginx 499'排查经历</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/20/PHP删除字符串中的emoji表情/">PHP删除字符串中的emoji表情</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/20/PHP调试小技巧/">PHP调试小技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/27/分销项目总结/">其实我在胡说八道</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/10/js获取url参数的值/">js获取url参数的值</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/25/MySQL服务器启动错误-The-server-quit-without-updating-PID-file/">MySQL服务器启动错误 'The server quit without updating PID file'</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/18/MySQL删除所有数据库/">MySQL删除所有数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/10/PHP中标量类型-隐式转换/">PHP中标量类型'隐式转换'</a></li></ul></div><div class="widget"><div class="widget-title">友情链接</div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">pein0119.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"></div></body></html>