<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Make the world a better place!"/><title>Redis-1.0代码阅读（六） –字典的实现 | pein0119</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis-1.0代码阅读（六） –字典的实现</h1><a id="logo" href="/">pein0119</a><p class="description">pein0119's blog</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Redis-1.0代码阅读（六） –字典的实现</h1><div class="post-meta">2014-08-20 | <span class="categories">分类于<a href="/categories/redis/">redis</a></span></div><div class="post-content"><p>参考资料（<a href="http://www.redisbook.com" target="_blank" rel="external">http://www.redisbook.com</a>）<br>参考了上面的的资料，但是，这份资料的作者阅读的redis版本和我阅读的版本不一样，对于他在书中提到的字典的功能，还没有验证。所以，只讨论字典的具体设计，它的应用场景可能要等到阅读完大部分代码才能知道。   </p>
<a id="more"></a>
<h2 id="文件依赖">文件依赖</h2><p>dict.h dict.c zmalloc.h </p>
<h2 id="字典实现">字典实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 哈希表结点 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictEntry &#123;</span><br><span class="line">    <span class="keyword">void</span> *key;					<span class="comment">/* 键 */</span></span><br><span class="line">    <span class="keyword">void</span> *val;					<span class="comment">/* 值 */</span></span><br><span class="line">    <span class="keyword">struct</span> dictEntry *next;		<span class="comment">/* 下一个结点 */</span></span><br><span class="line">&#125; dictEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictType &#123;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>; <span class="comment">/* 哈希函数 */</span></span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key); <span class="comment">/* 键复制函数 */</span></span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj); <span class="comment">/* 值复制函数 */</span></span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);     <span class="comment">/* 键比较函数 */</span></span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key); <span class="comment">/* 键析构函数 */</span></span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj); <span class="comment">/* 值析构函数 */</span></span><br><span class="line">&#125; dictType;</span><br><span class="line"><span class="comment">/* 字典 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dict &#123;</span><br><span class="line">    dictEntry **table;			<span class="comment">/* 哈希表 */</span></span><br><span class="line">    dictType *type;				<span class="comment">/* 字典的配套函数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;			<span class="comment">/* 哈希表的长度 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;		<span class="comment">/* 哈希表长度掩码，用于计算索引值 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;			<span class="comment">/* 已经使用的长度 */</span></span><br><span class="line">    <span class="keyword">void</span> *privdata;				<span class="comment">/* 私有数据 */</span></span><br><span class="line">&#125; dict;</span><br><span class="line"><span class="comment">/* 字典迭代器 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictIterator &#123;</span><br><span class="line">    dict *ht;					<span class="comment">/* 字典指针 */</span></span><br><span class="line">    <span class="keyword">int</span> index;					<span class="comment">/* 索引值 */</span></span><br><span class="line">    dictEntry *entry, *nextEntry; <span class="comment">/* 当前结点、下一个结点的指针 */</span></span><br><span class="line">&#125; dictIterator;</span><br></pre></td></tr></table></figure>
<p>字典的底层是使用哈希表实现的。<br>dictEntry是哈希表单个结点的实现。<br>dictType是与字典的配套函数。<br>dict就是字典的具体实现，由于哈希表使用的“链地址法”来处理冲突，具有相同哈希值的函数组成链表，所以table是一个指针的指针。sizemask是哈希表的长度掩码，计算出的哈希值与sizemask进行“位运算”–“与”，可以快速的计算出该结点在哈希表中的“索引”，当然也可以将哈希值和size进行模运算，但模运算相较于位运算，需要花费更多的开销。<br>dictIterator是字典的迭代器，用于实现对字典中哈希表的遍历。   </p>
<h3 id="结构示意图：">结构示意图：</h3><p><img src="https://github.com/pein0119/pein0119.github.io/blob/master/image/14-08-20-3.jpg?raw=true" alt=""> </p>
<h2 id="函数实现">函数实现</h2><h3 id="用宏实现的函数">用宏实现的函数</h3><p>对于一些简单的函数，仍然采用宏实现，省去函数调用的开销。 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictFreeEntryVal(ht, entry) \ <span class="comment">/* 释放哈希表结点的值 */</span></span></span><br><span class="line">    <span class="keyword">if</span> ((ht)-&gt;type-&gt;valDestructor) \</span><br><span class="line">        (ht)-&gt;type-&gt;valDestructor((ht)-&gt;privdata, (entry)-&gt;val)</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictSetHashVal(ht, entry, _val_) do &#123; \ <span class="comment">/* 设置哈希表结点的值 */</span></span></span><br><span class="line">    <span class="keyword">if</span> ((ht)-&gt;type-&gt;valDup) \</span><br><span class="line">        entry-&gt;val = (ht)-&gt;type-&gt;valDup((ht)-&gt;privdata, _val_); \</span><br><span class="line">    <span class="keyword">else</span> \</span><br><span class="line">        entry-&gt;val = (_val_); \</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictFreeEntryKey(ht, entry) \ <span class="comment">/* 释放哈希表结点的键 */</span></span></span><br><span class="line">    <span class="keyword">if</span> ((ht)-&gt;type-&gt;keyDestructor) \</span><br><span class="line">        (ht)-&gt;type-&gt;keyDestructor((ht)-&gt;privdata, (entry)-&gt;key)</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictSetHashKey(ht, entry, _key_) do &#123; \ <span class="comment">/* 设置哈希表结点的键 */</span></span></span><br><span class="line">    <span class="keyword">if</span> ((ht)-&gt;type-&gt;keyDup) \</span><br><span class="line">        entry-&gt;key = (ht)-&gt;type-&gt;keyDup((ht)-&gt;privdata, _key_); \</span><br><span class="line">    <span class="keyword">else</span> \</span><br><span class="line">        entry-&gt;key = (_key_); \</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictCompareHashKeys(ht, key1, key2) \ <span class="comment">/* 比较哈希表结点的键 */</span></span></span><br><span class="line">    (((ht)-&gt;type-&gt;keyCompare) ? \</span><br><span class="line">        (ht)-&gt;type-&gt;keyCompare((ht)-&gt;privdata, key1, key2) : \</span><br><span class="line">        (key1) == (key2))</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictHashKey(ht, key) (ht)-&gt;type-&gt;hashFunction(key) <span class="comment">/* 调用哈希函数得到哈希值 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictGetEntryKey(he) ((he)-&gt;key) <span class="comment">/* 得到哈希结点的键 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictGetEntryVal(he) ((he)-&gt;val) <span class="comment">/* 得到哈希结点的值 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictSlots(ht) ((ht)-&gt;size)		<span class="comment">/* 得到哈希表的总长度 */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> dictSize(ht) ((ht)-&gt;used)		<span class="comment">/* 得到哈希表已经使用的长度 */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="其他函数的具体实现">其他函数的具体实现</h3><h4 id="1-_“私有”函数">1. “私有”函数</h4><p>dict.c中有很多命令以下划线开头的函数，它们作为dict公共接口的内部接口。 使用static关键字，可以限定函数的作用域，使得这些函数只能让本程序中的其他函数访问，相当于c++中的私有成员。 </p>
<h4 id="_dictPanic">_dictPanic</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictPanic(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span><br><span class="line">&#123;</span><br><span class="line">    va_list ap;</span><br><span class="line"></span><br><span class="line">    va_start(ap, fmt);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\nDICT LIBRARY PANIC: "</span>);</span><br><span class="line">    <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, ap);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\n\n"</span>);</span><br><span class="line">    va_end(ap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数用于向标准错误(stderr)中打印出错信息。 </p>
<h5 id="堆管理函数">堆管理函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tatic <span class="keyword">void</span> *_dictAlloc(<span class="keyword">size_t</span> size) <span class="comment">/* 分配内存 */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *p = zmalloc(size);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">        _dictPanic(<span class="string">"Out of memory"</span>);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictFree(<span class="keyword">void</span> *ptr) &#123; <span class="comment">/* 释放内存 */</span></span><br><span class="line">    zfree(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个函数是对zmalloc和zfree函数的封装。   </p>
<h5 id="有关字典操作的私有函数">有关字典操作的私有函数</h5><p>(1) _dictReset  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 清空字典 */</span></span><br><span class="line"><span class="comment">/* Reset an hashtable already initialized with ht_init().</span><br><span class="line">* <span class="doctag">NOTE:</span> This function should only called by ht_destroy(). */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictReset(dict *ht)</span><br><span class="line">&#123;</span><br><span class="line">    ht-&gt;table = <span class="literal">NULL</span>;</span><br><span class="line">    ht-&gt;size = <span class="number">0</span>;</span><br><span class="line">    ht-&gt;sizemask = <span class="number">0</span>;</span><br><span class="line">    ht-&gt;used = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数用于将字典“清零”。  </p>
<p>(2) _dictInit   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 初始化字典中的哈希表 */</span></span><br><span class="line"><span class="comment">/* Initialize the hash table */</span></span><br><span class="line"><span class="keyword">int</span> _dictInit(dict *ht, dictType *type,</span><br><span class="line">        <span class="keyword">void</span> *privDataPtr)</span><br><span class="line">&#123;</span><br><span class="line">    _dictReset(ht);				<span class="comment">/* 先清空字典 */</span></span><br><span class="line">    ht-&gt;type = type;</span><br><span class="line">    ht-&gt;privdata = privDataPtr;</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化字典中的哈希表，初始化之前先要将字典“清零”。  </p>
<p>(3) _dictClear </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 销毁字典中的哈希表 */</span></span><br><span class="line"><span class="comment">/* Destroy an entire hash table */</span></span><br><span class="line"><span class="keyword">int</span> _dictClear(dict *ht)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i;</span><br><span class="line">    <span class="comment">/* 释放哈希表的每一个槽对应的链表中的每一个元素 */</span></span><br><span class="line">    <span class="comment">/* Free all the elements */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ht-&gt;size &amp;&amp; ht-&gt;used &gt; <span class="number">0</span>; i++) &#123;</span><br><span class="line">        dictEntry *he, *nextHe;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((he = ht-&gt;table[i]) == <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">while</span>(he) &#123;</span><br><span class="line">            nextHe = he-&gt;next;</span><br><span class="line">            dictFreeEntryKey(ht, he);</span><br><span class="line">            dictFreeEntryVal(ht, he);</span><br><span class="line">            _dictFree(he);</span><br><span class="line">            ht-&gt;used--;</span><br><span class="line">            he = nextHe;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">/* 释放整个哈希表 */</span></span><br><span class="line">    <span class="comment">/* Free the table and the allocated cache structure */</span></span><br><span class="line">    _dictFree(ht-&gt;table);</span><br><span class="line">    <span class="comment">/* Re-initialize the table */</span></span><br><span class="line">	_dictReset(ht);				<span class="comment">/* 将字典清零 */</span></span><br><span class="line">	<span class="keyword">return</span> DICT_OK; <span class="comment">/* never fails */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数用于销毁字典中的哈希表，先要释放哈希表中的每一个元素，然后调用_dictFree函数释放非配给table的内存，最后调用函数_dictReset将字典清零。  </p>
<p>(4) _dictExpandIfNeeded   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Expand the hash table if needed */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _dictExpandIfNeeded(dict *ht)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* If the hash table is empty expand it to the intial size,</span><br><span class="line">    * if the table is "full" dobule its size. */</span></span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> dictExpand(ht, DICT_HT_INITIAL_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;used == ht-&gt;size)	<span class="comment">/* 哈希表已满，将其容量扩大为原来的二倍 */</span></span><br><span class="line">        <span class="keyword">return</span> dictExpand(ht, ht-&gt;size*<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在哈希表的容量不足的时候扩展哈希表，哈希表大小为0时，容量扩展为“初始长度”为4；若非零，则容量扩展为原来的2倍。<br>(5) _dictNextPower   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 哈希表的容量是2的指数次方 */</span></span><br><span class="line"><span class="comment">/* Our hash table capability is a power of two */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> _dictNextPower(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i = DICT_HT_INITIAL_SIZE;</span><br><span class="line">    <span class="comment">/* LONG_MAX定义在limit.h中，指定long类型的最大值 */</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= LONG_MAX) <span class="keyword">return</span> LONG_MAX;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;                    <span class="comment">/* 但是size是unsigned long */</span></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size)            <span class="comment">/* 所以是否应该与ULONG_MAX比较 */</span></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        i *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>哈希表的容量大小是2的指数次方，该函数用于计算出大于size的2的指数次方。  </p>
<p>就像在注释中提到的，size的类型为unsigned long，所以size的上限是否应该是ULONG_MAX，而非LONG_MAX。  </p>
<p>(6) _dictKeyIndex  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 给定键，若键在哈希表中不存在，返回一个空槽的索引，若已存在，出错 */</span></span><br><span class="line"><span class="comment">/* Returns the index of a free slot that can be populated with</span><br><span class="line">* an hash entry for the given 'key'.</span><br><span class="line">* If the key already exists, -1 is returned. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _dictKeyIndex(dict *ht, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</span><br><span class="line">    dictEntry *he;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Expand the hashtable if needed */</span></span><br><span class="line">    <span class="keyword">if</span> (_dictExpandIfNeeded(ht) == DICT_ERR)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* Compute the key hash value */</span></span><br><span class="line">    h = dictHashKey(ht, key) &amp; ht-&gt;sizemask;</span><br><span class="line">    <span class="comment">/* Search if this slot does not already contain the given key */</span></span><br><span class="line">    he = ht-&gt;table[h];</span><br><span class="line">    <span class="keyword">while</span>(he) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dictCompareHashKeys(ht, key, he-&gt;key))</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        he = he-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给定一个键，查找这个键在哈希表是否已经存在，如果已经存在了，返回-1；如果这个键不存在，返回这个键在哈希表中对应的索引。  </p>
<h4 id="StringCopy对应的哈希表函数原型">StringCopy对应的哈希表函数原型</h4><p>(1) _dictStringCopyHTHashFunction  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 调用哈希函数生成key对应的哈希值 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> _dictStringCopyHTHashFunction(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> dictGenHashFunction(key, <span class="built_in">strlen</span>(key));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StringCopy使用的哈希函数。  </p>
<p>(2) _dictStringCopyHTKeyDup  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 键复制函数 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *_dictStringCopyHTKeyDup(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(key);</span><br><span class="line">    <span class="keyword">char</span> *copy = _dictAlloc(len+<span class="number">1</span>);</span><br><span class="line">    DICT_NOTUSED(privdata);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(copy, key, len);</span><br><span class="line">    copy[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) _dictStringKeyValCopyHTValDup  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 值赋值函数 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *_dictStringKeyValCopyHTValDup(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *val)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(val);</span><br><span class="line">    <span class="keyword">char</span> *copy = _dictAlloc(len+<span class="number">1</span>);</span><br><span class="line">    DICT_NOTUSED(privdata);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(copy, val, len);</span><br><span class="line">    copy[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(4) _dictStringCopyHTKeyCompare  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 键比较函数 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _dictStringCopyHTKeyCompare(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">void</span> *key2)</span><br><span class="line">&#123;</span><br><span class="line">    DICT_NOTUSED(privdata);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>(key1, key2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(5) _dictStringCopyHTKeyDestructor  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 键析构函数 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictStringCopyHTKeyDestructor(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    DICT_NOTUSED(privdata);</span><br><span class="line"></span><br><span class="line">    _dictFree((<span class="keyword">void</span>*)key); <span class="comment">/* ATTENTION: const cast */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(6)  _dictStringKeyValCopyHTValDestructor  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 值析构函数 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictStringKeyValCopyHTValDestructor(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *val)</span><br><span class="line">&#123;</span><br><span class="line">    DICT_NOTUSED(privdata);</span><br><span class="line"></span><br><span class="line">    _dictFree((<span class="keyword">void</span>*)val); <span class="comment">/* ATTENTION: const cast */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-_哈希函数">2. 哈希函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Thomas Wang's 32 bit Mix Function */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictIntHashFunction</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> key)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    key += ~(key &lt;&lt; <span class="number">15</span>);</span><br><span class="line">    key ^=  (key &gt;&gt; <span class="number">10</span>);</span><br><span class="line">    key +=  (key &lt;&lt; <span class="number">3</span>);</span><br><span class="line">    key ^=  (key &gt;&gt; <span class="number">6</span>);</span><br><span class="line">    key += ~(key &lt;&lt; <span class="number">11</span>);</span><br><span class="line">    key ^=  (key &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Identity hash function for integer keys */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictIdentityHashFunction</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> key)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Generic hash function (a popular one from Bernstein).</span><br><span class="line">* I tested a few and this was the best. */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictGenHashFunction</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hash = <span class="number">5381</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (len--)</span><br><span class="line">        hash = ((hash &lt;&lt; <span class="number">5</span>) + hash) + (*buf++); <span class="comment">/* hash * 33 + c */</span></span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这三个是字典使用的哈希函数，讨论这些函数性能是否优良，超出了我的能力范围。  </p>
<h5 id="dict对外提供的接口">dict对外提供的接口</h5><h6 id="1-_dictCreate">1. dictCreate</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建字典，初始化除table之外的其他元素，此时哈希表是空的 */</span></span><br><span class="line"><span class="comment">/* Create a new hash table */</span></span><br><span class="line"><span class="function">dict *<span class="title">dictCreate</span><span class="params">(dictType *type,</span><br><span class="line">        <span class="keyword">void</span> *privDataPtr)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dict *ht = _dictAlloc(<span class="keyword">sizeof</span>(*ht));</span><br><span class="line"></span><br><span class="line">    _dictInit(ht,type,privDataPtr);</span><br><span class="line">    <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建字典，调用_dictAlloc分配内存， 调用_dictInit初始化字典。   </p>
<h6 id="2-_dictResize">2. dictResize</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Resize the table to the minimal size that contains all the elements,</span><br><span class="line">* but with the invariant of a USER/BUCKETS ration near to &lt;= 1 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictResize</span><span class="params">(dict *ht)</span>        <span class="comment">/* 将字典中哈希表的长度调到最小 */</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> minimal = ht-&gt;used;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">        minimal = DICT_HT_INITIAL_SIZE;</span><br><span class="line">    <span class="keyword">return</span> dictExpand(ht, minimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将哈希表的调节到最小–如果为空，调节为4；如果非空，调节到used大写。  </p>
<h6 id="3-_dictExpand">3. dictExpand</h6><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/* Resize the table to the minimal size that contains all the elements,</span><br><span class="line">* but with the invariant of a USER/BUCKETS ration near to &lt;= 1 */</span><br><span class="line">int dictResize(dict *ht)        /* 将字典中哈希表的长度调到最小 */</span><br><span class="line">&#123;</span><br><span class="line">    int minimal = ht-&gt;used;</span><br><span class="line"></span><br><span class="line">    if (minimal &lt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">        minimal = DICT_HT_INITIAL_SIZE;</span><br><span class="line">    return dictExpand(ht, minimal);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* Expand or create the hashtable */</span><br><span class="line">int dictExpand(dict *ht, unsigned long size)</span><br><span class="line">&#123;                                /* 创建一个新的哈希表 */</span><br><span class="line">    dict n; /* the new hashtable */</span><br><span class="line">    unsigned long realsize = _dictNextPower(size), i;</span><br><span class="line">    /* 如果给定的size小于原表中已经使用的大小，则出错 */</span><br><span class="line">    /* the size is invalid if it is smaller than the number of</span><br><span class="line">    * elements already inside the hashtable */</span><br><span class="line">    if (ht-&gt;used &gt; size)</span><br><span class="line">        return DICT_ERR;</span><br><span class="line"></span><br><span class="line">    _dictInit(&amp;n, ht-&gt;type, ht-&gt;privdata);</span><br><span class="line">    n.size = realsize;</span><br><span class="line">    n.sizemask = realsize-1;</span><br><span class="line">    n.table = _dictAlloc(realsize*sizeof(dictEntry*));</span><br><span class="line">    /* 将哈希表中的所有指针初始化为NULL */</span><br><span class="line">    /* Initialize all the pointers to NULL */</span><br><span class="line">    memset(n.table, 0, realsize*sizeof(dictEntry*));</span><br><span class="line"></span><br><span class="line">    /* Copy all the elements from the old to the new table:</span><br><span class="line">	* note that if the old hash table is empty ht-&gt;size is zero,</span><br><span class="line">	* so dictExpand just creates an hash table. */</span><br><span class="line">	n.used = ht-&gt;used;</span><br><span class="line">	for (i = 0; i &lt; ht-&gt;size &amp;&amp; ht-&gt;used &gt; 0; i++) &#123;</span><br><span class="line">	    dictEntry *he, *nextHe;</span><br><span class="line"></span><br><span class="line">        if (ht-&gt;table[i] == NULL) continue;</span><br><span class="line"></span><br><span class="line">        /* For each hash entry on this slot... */</span><br><span class="line">        he = ht-&gt;table[i];</span><br><span class="line">        while(he) &#123;</span><br><span class="line">            unsigned int h;</span><br><span class="line"></span><br><span class="line">            nextHe = he-&gt;next;</span><br><span class="line">            /* Get the new element index */</span><br><span class="line">            h = dictHashKey(ht, he-&gt;key) &amp; n.sizemask;</span><br><span class="line">            he-&gt;next = n.table[h];</span><br><span class="line">            n.table[h] = he;</span><br><span class="line">            ht-&gt;used--;</span><br><span class="line">            /* Pass to the next element */</span><br><span class="line">            he = nextHe;</span><br><span class="line">        &#125; /* 190行的代码相当于 "h = dictHashKey(ht, he-&gt;key) % n.size" */</span><br><span class="line">    &#125;      /* 使用位运算可以比取模运算节省很多时间 */</span><br><span class="line">    assert(ht-&gt;used == 0);</span><br><span class="line">    _dictFree(ht-&gt;table);        /* 释放字典ht中的哈希表 */</span><br><span class="line"></span><br><span class="line">    /* Remap the new hashtable in the old */</span><br><span class="line">    *ht = n;                    /* 将字典n中存储的内容赋给ht指向的字典 */</span><br><span class="line">    return DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数用于扩展或创建一个哈希表，它先创建一个临时的字典，将ht指向的字典的type,size,sizemask,used,privdata赋给临时字典n,然后对对ht-&gt;table中存储的每个元素重新计算哈希值，存储在n.table中，最后将n的内容赋给ht指向的字典。  </p>
<h6 id="4-_dictAdd">4. dictAdd</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Add an element to the target hash table */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictAdd</span><span class="params">(dict *ht, <span class="keyword">void</span> *key, <span class="keyword">void</span> *val)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    dictEntry *entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get the index of the new element, or -1 if</span><br><span class="line">    * the element already exists. */</span></span><br><span class="line">    <span class="keyword">if</span> ((index = _dictKeyIndex(ht, key)) == -<span class="number">1</span>) <span class="comment">/* 获取key对应的索引 */</span></span><br><span class="line">        <span class="keyword">return</span> DICT_ERR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocates the memory and stores key */</span></span><br><span class="line">    entry = _dictAlloc(<span class="keyword">sizeof</span>(*entry)); <span class="comment">/* 为键值分配内存 */</span></span><br><span class="line">    entry-&gt;next = ht-&gt;table[index];        <span class="comment">/* 将结点插入到对应的索引链表中 */</span></span><br><span class="line">    ht-&gt;table[index] = entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the hash entry fields. */</span></span><br><span class="line">    dictSetHashKey(ht, entry, key); <span class="comment">/* 设置结点的各个域 */</span></span><br><span class="line">    dictSetHashVal(ht, entry, val);</span><br><span class="line">    ht-&gt;used++;</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>向目标字典中添加元素。  </p>
<h6 id="5-_dictReplace">5. dictReplace</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 将键值插入到哈希表中，不管键对应的结点在哈希表中是否已经存在 */</span></span><br><span class="line"><span class="comment">/* Add an element, discarding the old if the key already exists */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictReplace</span><span class="params">(dict *ht, <span class="keyword">void</span> *key, <span class="keyword">void</span> *val)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dictEntry *entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Try to add the element. If the key</span><br><span class="line">    * does not exists dictAdd will suceed. */</span></span><br><span class="line">    <span class="keyword">if</span> (dictAdd(ht, key, val) == DICT_OK)</span><br><span class="line">        <span class="keyword">return</span> DICT_OK;</span><br><span class="line">    <span class="comment">/* It already exists, get the entry */</span></span><br><span class="line">    entry = dictFind(ht, key);</span><br><span class="line">    <span class="comment">/* Free the old value and set the new one */</span></span><br><span class="line">    dictFreeEntryVal(ht, entry);</span><br><span class="line">    dictSetHashVal(ht, entry, val);</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果“键值对”在哈希表中已经存在， 则更新“键”对应的“值”；如果不存在，将该“键值对”插入到哈希表中。  </p>
<h6 id="6-_dictGenericDelete">6. dictGenericDelete</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 查找并删除一个元素 */</span></span><br><span class="line"><span class="comment">/* Search and remove an element */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dictGenericDelete</span><span class="params">(dict *ht, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">int</span> nofree)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</span><br><span class="line">    dictEntry *he, *prevHe;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    h = dictHashKey(ht, key) &amp; ht-&gt;sizemask;</span><br><span class="line">    he = ht-&gt;table[h];</span><br><span class="line"></span><br><span class="line">    prevHe = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>(he) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dictCompareHashKeys(ht, key, he-&gt;key)) &#123;</span><br><span class="line">            <span class="comment">/* Unlink the element from the list */</span></span><br><span class="line">            <span class="keyword">if</span> (prevHe)            <span class="comment">/* 要删除的结点不是头结点 */</span></span><br><span class="line">                prevHe-&gt;next = he-&gt;next;</span><br><span class="line">            <span class="keyword">else</span>                <span class="comment">/* 要删除的是头结点 */</span></span><br><span class="line">                ht-&gt;table[h] = he-&gt;next;</span><br><span class="line">            <span class="keyword">if</span> (!nofree) &#123;        <span class="comment">/* 调用者指定参数释放key和value */</span></span><br><span class="line">                dictFreeEntryKey(ht, he);</span><br><span class="line">                dictFreeEntryVal(ht, he);</span><br><span class="line">            &#125;</span><br><span class="line">            _dictFree(he);        <span class="comment">/* 释放结点 */</span></span><br><span class="line">            ht-&gt;used--;</span><br><span class="line">            <span class="keyword">return</span> DICT_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        prevHe = he;</span><br><span class="line">        he = he-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DICT_ERR; <span class="comment">/* not found */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从字典的哈希表中删除一个结点，nofree指定了是否释放该结点对应的“键值对”。  </p>
<h6 id="7-_dictDelete">7. dictDelete</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 释放键对应的结点的key和value */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictDelete</span><span class="params">(dict *ht, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dictGenericDelete(ht,key,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用dictGenericDelete函数，删除对应的结点，并释放结点对应的“键值对”。  </p>
<h6 id="8-_dictDeleteNoFree">8. dictDeleteNoFree</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 不释放键对应的结点的key和value */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictDeleteNoFree</span><span class="params">(dict *ht, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dictGenericDelete(ht,key,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只删除结点，不删除对应的“键值对”。  </p>
<h6 id="9-_dictRelease">9. dictRelease</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 先将字典清零，再释放掉整个字典 */</span></span><br><span class="line"><span class="comment">/* Clear &amp; Release the hash table */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictRelease</span><span class="params">(dict *ht)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    _dictClear(ht);</span><br><span class="line">    _dictFree(ht);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先将字典清零，再释放掉整个字典。  </p>
<h6 id="10-_dictFind">10. dictFind</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 查找给定键对应的结点 */</span></span><br><span class="line"><span class="function">dictEntry *<span class="title">dictFind</span><span class="params">(dict *ht, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dictEntry *he;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;size == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    h = dictHashKey(ht, key) &amp; ht-&gt;sizemask;</span><br><span class="line">    he = ht-&gt;table[h];<span class="function">w</span><br><span class="line">    <span class="title">while</span><span class="params">(he)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dictCompareHashKeys(ht, key, he-&gt;key))</span><br><span class="line">            <span class="keyword">return</span> he;</span><br><span class="line">        he = he-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找某个结点，未找到，返回NULL。  </p>
<h6 id="11-_dictGetIterator">11. dictGetIterator</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 获取一个给定字典的迭代器，并初始化 */</span></span><br><span class="line"><span class="function">dictIterator *<span class="title">dictGetIterator</span><span class="params">(dict *ht)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dictIterator *iter = _dictAlloc(<span class="keyword">sizeof</span>(*iter));</span><br><span class="line">    <span class="comment">/* 该迭代器返回当前索引的下一个非空索引对应的链表的首结点 */</span></span><br><span class="line">    iter-&gt;ht = ht;</span><br><span class="line">    iter-&gt;index = -<span class="number">1</span>;</span><br><span class="line">    iter-&gt;entry = <span class="literal">NULL</span>;</span><br><span class="line">    iter-&gt;nextEntry = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> iter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取迭代器，并初始化。  </p>
<h6 id="12-_dictNext">12. dictNext</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dictEntry *<span class="title">dictNext</span><span class="params">(dictIterator *iter)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            iter-&gt;index++;</span><br><span class="line">            <span class="keyword">if</span> (iter-&gt;index &gt;=</span><br><span class="line">                (<span class="keyword">signed</span>)iter-&gt;ht-&gt;size) <span class="keyword">break</span>;</span><br><span class="line">            iter-&gt;entry = iter-&gt;ht-&gt;table[iter-&gt;index];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            iter-&gt;entry = iter-&gt;nextEntry;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;entry) &#123;</span><br><span class="line">            <span class="comment">/* We need to save the 'next' here, the iterator user</span><br><span class="line">            * may delete the entry we are returning. */</span></span><br><span class="line">            iter-&gt;nextEntry = iter-&gt;entry-&gt;next;</span><br><span class="line">            <span class="keyword">return</span> iter-&gt;entry;    <span class="comment">/* 我们要把下一个结点保存起来 */</span></span><br><span class="line">        &#125;                        <span class="comment">/* 调用者有可能会删除我们返回的结点*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取当前迭代器指向的下一个结点。  </p>
<h6 id="13-_dictReleaseIterator">13. dictReleaseIterator</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 销毁迭代器 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictReleaseIterator</span><span class="params">(dictIterator *iter)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    _dictFree(iter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>销毁迭代器  </p>
<h6 id="14-_dictGetRandomKey">14. dictGetRandomKey</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 返回哈希表中的一个随机结点，这对实现随机化算法很有用 */</span></span><br><span class="line"><span class="comment">/* Return a random entry from the hash table. Useful to</span><br><span class="line">* implement randomized algorithms */</span></span><br><span class="line"><span class="function">dictEntry *<span class="title">dictGetRandomKey</span><span class="params">(dict *ht)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dictEntry *he;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">int</span> listlen, listele;</span><br><span class="line">    <span class="comment">/* 字典的哈希表未存储结点 */</span></span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;used == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        h = random() &amp; ht-&gt;sizemask;</span><br><span class="line">        he = ht-&gt;table[h];</span><br><span class="line">    &#125; <span class="keyword">while</span>(he == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Now we found a non empty bucket, but it is a linked</span><br><span class="line">    * list and we need to get a random element from the list.</span><br><span class="line">    * The only sane way to do so is to count the element and</span><br><span class="line">    * select a random index. */</span></span><br><span class="line">    listlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(he) &#123;</span><br><span class="line">        he = he-&gt;next;</span><br><span class="line">        listlen++;</span><br><span class="line">    &#125;</span><br><span class="line">    listele = random() % listlen;</span><br><span class="line">    he = ht-&gt;table[h];</span><br><span class="line">    <span class="keyword">while</span>(listele--) he = he-&gt;next;</span><br><span class="line">    <span class="keyword">return</span> he;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回哈希表中的一个随机结点。  </p>
<h6 id="15-_dictPrintStats">15. dictPrintStats</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DICT_STATS_VECTLEN <span class="number">50</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictPrintStats</span><span class="params">(dict *ht)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i, slots = <span class="number">0</span>, chainlen, maxchainlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> totchainlen = <span class="number">0</span>; <span class="comment">/* 整个哈希表中一共又多少个结点 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> clvector[DICT_STATS_VECTLEN];</span><br><span class="line">    <span class="comment">/* 字典为空 */</span></span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;used == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"No stats available for empty dictionaries\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; DICT_STATS_VECTLEN; i++) clvector[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ht-&gt;size; i++) &#123;</span><br><span class="line">        dictEntry *he;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ht-&gt;table[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            clvector[<span class="number">0</span>]++;        </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        slots++;</span><br><span class="line">        <span class="comment">/* For each hash entry on this slot... */</span></span><br><span class="line">        chainlen = <span class="number">0</span>;</span><br><span class="line">        he = ht-&gt;table[i];</span><br><span class="line">        <span class="keyword">while</span>(he) &#123;                <span class="comment">/* 哈希表的该位置对应的链表又多少个结点 */</span></span><br><span class="line">            chainlen++;</span><br><span class="line">            he = he-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        clvector[(chainlen &lt; DICT_STATS_VECTLEN) ? chainlen : (DICT_STATS_VECTLEN-<span class="number">1</span>)]++;</span><br><span class="line">        <span class="keyword">if</span> (chainlen &gt; maxchainlen) maxchainlen = chainlen; <span class="comment">/* 更新最大的链长度 */</span></span><br><span class="line">        totchainlen += chainlen;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hash table stats:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" table size: %ld\n"</span>, ht-&gt;size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" number of elements: %ld\n"</span>, ht-&gt;used);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" different slots: %ld\n"</span>, slots);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" max chain length: %ld\n"</span>, maxchainlen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" avg chain length (counted): %.02f\n"</span>, (<span class="keyword">float</span>)totchainlen/slots);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" avg chain length (computed): %.02f\n"</span>, (<span class="keyword">float</span>)ht-&gt;used/slots);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" Chain length distribution:\n"</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; DICT_STATS_VECTLEN-<span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clvector[i] == <span class="number">0</span>) <span class="keyword">continue</span>; <span class="comment">/* 链长度分布，即长度为len的槽(slot)的个数占整个哈希表长度size的百分比 */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"   %s%ld: %ld (%.02f%%)\n"</span>,(i == DICT_STATS_VECTLEN-<span class="number">1</span>)?<span class="string">"&gt;= "</span>:<span class="string">""</span>, i, clvector[i], ((<span class="keyword">float</span>)clvector[i]/ht-&gt;size)*<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印字典的相关信息。  </p>
<h6 id="dict配套函数">dict配套函数</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 当key为字符串并且要复制key时封装的函数 */</span></span><br><span class="line">dictType dictTypeHeapStringCopyKey = &#123;</span><br><span class="line">    _dictStringCopyHTHashFunction,        <span class="comment">/* hash function */</span></span><br><span class="line">    _dictStringCopyHTKeyDup,              <span class="comment">/* key dup */</span></span><br><span class="line">    <span class="literal">NULL</span>,                               <span class="comment">/* val dup */</span></span><br><span class="line">    _dictStringCopyHTKeyCompare,          <span class="comment">/* key compare */</span></span><br><span class="line">    _dictStringCopyHTKeyDestructor,       <span class="comment">/* key destructor */</span></span><br><span class="line">    <span class="literal">NULL</span>                                <span class="comment">/* val destructor */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 当key为字符串但不许要复制key时封装的函数，用于解释器的共享字符串 */</span></span><br><span class="line"><span class="comment">/* This is like StringCopy but does not auto-duplicate the key.</span><br><span class="line">* It's used for intepreter's shared strings. */</span></span><br><span class="line">dictType dictTypeHeapStrings = &#123;</span><br><span class="line">    _dictStringCopyHTHashFunction,        <span class="comment">/* hash function */</span></span><br><span class="line">    <span class="literal">NULL</span>,                               <span class="comment">/* key dup */</span></span><br><span class="line">    <span class="literal">NULL</span>,                               <span class="comment">/* val dup */</span></span><br><span class="line">    _dictStringCopyHTKeyCompare,          <span class="comment">/* key compare */</span></span><br><span class="line">    _dictStringCopyHTKeyDestructor,       <span class="comment">/* key destructor */</span></span><br><span class="line">    <span class="literal">NULL</span>                                <span class="comment">/* val destructor */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 需要同时复制key和value时封装的函数 */</span></span><br><span class="line"><span class="comment">/* This is like StringCopy but also automatically handle dynamic</span><br><span class="line">* allocated C strings as values. */</span></span><br><span class="line">dictType dictTypeHeapStringCopyKeyValue = &#123;</span><br><span class="line">    _dictStringCopyHTHashFunction,        <span class="comment">/* hash function */</span></span><br><span class="line">    _dictStringCopyHTKeyDup,              <span class="comment">/* key dup */</span></span><br><span class="line">    _dictStringKeyValCopyHTValDup,        <span class="comment">/* val dup */</span></span><br><span class="line">    _dictStringCopyHTKeyCompare,          <span class="comment">/* key compare */</span></span><br><span class="line">    _dictStringCopyHTKeyDestructor,       <span class="comment">/* key destructor */</span></span><br><span class="line">    _dictStringKeyValCopyHTValDestructor, <span class="comment">/* val destructor */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>dict中的type成员可以指向三个结构体中的一个。  </p>
<p>(dict部分结束)</p>
</div><div class="tags"><a href="/tags/redis/">redis</a></div><div class="post-nav"><a href="/2014/08/26/【译】php中的'=='和'==='/" class="pre"><i class="icon-previous">【译】php中的 '==' 和 '==='</i></a><a href="/2014/08/20/Redis-10代码阅读（五）---简单动态字符串(sds)的实现/" class="next">Redis-1.0代码阅读（五） --简单动态字符串(sds)的实现<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/bash/">bash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法与数据结构/">算法与数据结构</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/SQL注入/" style="font-size: 15px;">SQL注入</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/cookie/" style="font-size: 15px;">cookie</a> <a href="/tags/session/" style="font-size: 15px;">session</a> <a href="/tags/算法与数据结构/" style="font-size: 15px;">算法与数据结构</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/php-fpm/" style="font-size: 15px;">php-fpm</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/bash/" style="font-size: 15px;">bash</a> <a href="/tags/emoji/" style="font-size: 15px;">emoji</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/11/27/bash代码片段/">bash代码片段</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/记一次-nginx-499-排查经历/">记一次'nginx 499'排查经历</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/20/PHP删除字符串中的emoji表情/">PHP删除字符串中的emoji表情</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/20/PHP调试小技巧/">PHP调试小技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/27/分销项目总结/">其实我在胡说八道</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/10/js获取url参数的值/">js获取url参数的值</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/25/MySQL服务器启动错误-The-server-quit-without-updating-PID-file/">MySQL服务器启动错误 'The server quit without updating PID file'</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/18/MySQL删除所有数据库/">MySQL删除所有数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/10/PHP中标量类型-隐式转换/">PHP中标量类型'隐式转换'</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/03/浏览器禁用cookie后如何使用session/">浏览器禁用cookie后如何使用session</a></li></ul></div><div class="widget"><div class="widget-title">友情链接</div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">pein0119.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"></div></body></html>